<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Desarme a Bomba Matem√°tica 2.0</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        /* Estilos personalizados para aprimorar o visual do jogo */
        :root {
            --primary-color: #ff4757; /* Vermelho vibrante */
            --dark-bg: #1a1a2e; /* Azul escuro profundo */
            --light-bg: #1f1f3a; /* Azul escuro ligeiramente mais claro */
            --text-color: #e0e0e0; /* Cinza claro para o texto */
            --success-color: #2ecc71; /* Verde para sucesso */
            --info-color: #3498db; /* Azul para informa√ß√µes/dicas */
            --font-family: 'Poppins', sans-serif;
            --border-color: #333; /* Cor para bordas sutis */
        }

        body {
            background-color: var(--dark-bg);
            color: var(--text-color);
            font-family: var(--font-family);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            overflow: hidden; /* Evita barras de rolagem durante anima√ß√µes */
        }

        .game-container {
            background-color: var(--light-bg);
            border-radius: 15px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            border: 2px solid var(--primary-color);
            transition: transform 0.3s ease;
            position: relative; 
        }

        .btn-start {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            padding: 12px 30px;
            border-radius: 50px;
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 4px 15px rgba(255, 71, 87, 0.4);
        }

        .btn-start:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(255, 71, 87, 0.6);
        }

        /* Estilos para os Modais do Bootstrap */
        .modal-content {
            background-color: var(--light-bg);
            border: 1px solid var(--primary-color);
            border-radius: 15px;
        }

        .modal-header, .modal-footer {
            border-bottom: 1px solid var(--border-color);
            border-top: 1px solid var(--border-color);
        }
        
        .modal-title {
            color: var(--primary-color);
            font-weight: 700;
        }
        .modal-header .btn-close {
            filter: invert(1); /* Deixa o X branco */
        }


        .answer-btn {
            width: 100%;
            margin: 8px 0;
            font-size: 1.1rem;
        }
        
        .progress-bar {
            background-color: var(--primary-color);
            transition: width 1s linear !important;
        }

        /* Anima√ß√£o de Explos√£o Melhorada */
        @keyframes screen-shake {
            0% { transform: translate(0, 0) rotate(0); }
            10%, 30%, 50%, 70%, 90% { transform: translate(-5px, 5px) rotate(-1deg); }
            20%, 40%, 60%, 80% { transform: translate(5px, -5px) rotate(1deg); }
            100% { transform: translate(0, 0) rotate(0); }
        }

        .explode-animation {
            animation: screen-shake 0.5s ease-in-out;
        }

        /* Estilos para o Ranking */
        .ranking-table {
            color: var(--text-color);
        }
        .ranking-table th {
            color: var(--primary-color);
        }
        .ranking-table tbody tr:nth-child(odd) {
            background-color: rgba(0, 0, 0, 0.2);
        }
        .ranking-table tbody tr:hover {
            background-color: rgba(255, 71, 87, 0.1);
        }
        .ranking-table .completed-game {
            background-color: rgba(46, 204, 113, 0.2) !important; /* Sucesso */
            font-weight: bold;
        }

        /* Cores dos bot√µes de dificuldade personalizados */
        .btn-difficulty {
            background-color: var(--light-bg); /* Fundo padr√£o do container */
            color: var(--primary-color); /* Texto vermelho */
            border: 2px solid var(--primary-color); /* Borda vermelha */
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        .btn-difficulty:hover {
            background-color: var(--primary-color); /* Fundo vermelho no hover */
            color: white; /* Texto branco no hover */
            border-color: var(--primary-color); /* Borda vermelha no hover */
        }
        /* Cor espec√≠fica para o n√≠vel professor */
        .btn-difficulty[data-difficulty="professor"] {
            color: var(--info-color);
            border-color: var(--info-color);
        }
        .btn-difficulty[data-difficulty="professor"]:hover {
            background-color: var(--info-color);
            color: white;
        }

        /* Bot√µes de op√ß√£o de resposta */
        .answer-btn.btn-outline-light {
            border-color: var(--text-color);
            color: var(--text-color);
        }
        .answer-btn.btn-outline-light:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Estilo para o bot√£o de apagar dados mais discreto e fora do modal */
        .btn-clear-data {
            position: fixed; /* Posi√ß√£o fixa na viewport */
            bottom: 15px;
            right: 15px; /* Posicionado no canto inferior direito */
            font-size: 1.8rem; /* Tamanho maior para o √≠cone */
            padding: 5px 10px;
            background: transparent;
            color: rgba(255, 255, 255, 0.3); /* Mais discreto */
            border: none; /* Sem borda inicial */
            border-radius: 5px;
            transition: all 0.3s ease;
            cursor: pointer;
            z-index: 1000; /* Garante que esteja acima de outros elementos, mas abaixo dos modais */
        }
        .btn-clear-data:hover {
            color: var(--primary-color);
            transform: scale(1.1); /* Um pequeno zoom no hover */
            background-color: rgba(255, 71, 87, 0.05); /* Fundo sutil no hover */
        }

        /* Estilo para o alerta de modo admin */
        .admin-alert {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #2ecc71; /* Verde */
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: bold;
            z-index: 1060; /* Acima de outros modais */
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .admin-alert.show {
            opacity: 1;
        }
    </style>
</head>
<body>

    <div class="game-container" id="startScreen">
        <h1 class="display-4 fw-bold text-danger mb-3">Desarme a Bomba üí£</h1>
        <p class="lead mb-4">Responda corretamente antes que o tempo se esgote para evitar a explos√£o!</p>
        <div class="d-grid gap-3 col-8 mx-auto mt-4"> <button class="btn btn-start btn-lg" onclick="showNameModal()">Iniciar Jogo</button>
            <button class="btn btn-outline-light btn-lg" onclick="showRanking()">Ver Ranking</button>
        </div>
    </div>

    <button class="btn btn-clear-data" onclick="clearAllData()" title="Apagar todos os dados salvos">üóëÔ∏è</button>

    <div id="adminModeAlert" class="admin-alert">
        Modo Admin Ativado!
    </div>

    <div class="modal fade" id="nameModal" tabindex="-1" aria-labelledby="nameModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="nameModalLabel">Qual o seu nome?</h5>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="playerNameInput" class="form-label">Nome:</label>
                        <input type="text" class="form-control" id="playerNameInput" placeholder="Digite seu nome aqui" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="continueToDifficultyBtn">Continuar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirmPlayerModal" tabindex="-1" aria-labelledby="confirmPlayerModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmPlayerModalLabel">Bem-vindo(a) de volta!</h5>
                </div>
                <div class="modal-body">
                    <p class="lead">Deseja continuar como <strong id="lastPlayerNameText"></strong>?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="changePlayerNameBtn">Mudar Nome</button>
                    <button type="button" class="btn btn-primary" id="continueWithLastPlayerBtn">Sim, continuar!</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="difficultyModal" tabindex="-1" aria-labelledby="difficultyModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="difficultyModalLabel">Escolha a Dificuldade</h5>
                </div>
                <div class="modal-body d-grid gap-3">
                    <button class="btn btn-lg btn-difficulty" data-difficulty="facil">F√°cil (5 quest√µes)</button>
                    <button class="btn btn-lg btn-difficulty" data-difficulty="medio">M√©dio (10 quest√µes)</button>
                    <button class="btn btn-lg btn-difficulty" data-difficulty="dificil">Dif√≠cil (20 quest√µes)</button>
                    <button class="btn btn-lg btn-difficulty" data-difficulty="professor">N√≠vel Professor (5 quest√µes avan√ßadas)</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="questionModal" tabindex="-1" aria-labelledby="questionModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="questionModalLabel">Quest√£o <span id="questionCount"></span></h5>
                    <button class="btn btn-info btn-sm ms-auto" id="hintButton">Dica</button>
                </div>
                <div class="modal-body">
                    <p class="lead fs-4" id="questionText"></p>
                    <div class="d-grid gap-2" id="answersContainer">
                        </div>
                    <div class="progress mt-4" style="height: 10px;">
                        <div id="timerBar" class="progress-bar" role="progressbar" style="width: 100%;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="hintModal" tabindex="-1" aria-labelledby="hintModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="hintModalLabel">Dica! ü§î</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <p id="hintText"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Entendi!</button>
                </div>
            </div>
        </div>
    </div>


    <div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-center">
                <div class="modal-body p-5">
                    <h2 class="display-3" id="resultIcon"></h2>
                    <h3 class="my-3" id="resultTitle"></h3>
                    <p class="lead" id="resultMessage"></p>
                    <button class="btn btn-start mt-3" onclick="restartGame()">Jogar Novamente</button>
                    <button class="btn btn-outline-info mt-3 ms-2" onclick="showRankingFromResults()">Ver Ranking</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="rankingModal" tabindex="-1" aria-labelledby="rankingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="rankingModalLabel">Ranking dos Melhores Desarmadores üèÜ</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-hover ranking-table">
                        <thead>
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">Nome</th>
                                <th scope="col">Acertos</th>
                                <th scope="col">Total</th>
                                <th scope="col">Tempo</th>
                                <th scope="col">Dificuldade</th>
                            </tr>
                        </thead>
                        <tbody id="rankingTableBody">
                            </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- CONFIGURA√á√ïES DO JOGO ---
        const allQuestions = [
            // √Ålgebra B√°sica
            { question: 'Se 3x + 5 = 17, qual √© o valor de x?', options: ['4', '3', '5', '6'], correct: '4', hint: 'Subtraia 5 de ambos os lados e depois divida por 3.', level: 'facil' },
            { question: 'Resolva a equa√ß√£o: 2(y - 3) = 10', options: ['8', '7', '9', '11'], correct: '8', hint: 'Divida por 2 primeiro, depois adicione 3.', level: 'medio' },
            { question: 'Qual o valor de 5x - 2y, se x=4 e y=3?', options: ['14', '20', '16', '10'], correct: '14', hint: 'Substitua os valores de x e y na express√£o.', level: 'facil' },
            
            // N√∫meros inteiros, fracion√°rios e equa√ß√£o do 1¬∫ grau
            { question: 'Quanto √© 1/2 + 1/3?', options: ['5/6', '2/5', '1/6', '3/5'], correct: '5/6', hint: 'Encontre um denominador comum para as fra√ß√µes.', level: 'facil' },
            { question: 'Se -8 + x = -3, qual o valor de x?', options: ['5', '-5', '11', '-11'], correct: '5', hint: 'Isole x somando 8 em ambos os lados.', level: 'facil' },
            { question: 'Qual √© o resultado de 0.75 + 1/4?', options: ['1', '0.5', '1.25', '1.5'], correct: '1', hint: 'Converta a fra√ß√£o para decimal ou o decimal para fra√ß√£o e some.', level: 'facil' },
            { question: 'Resolva a equa√ß√£o: 4x - 7 = 13', options: ['5', '6', '4', '3'], correct: '5', hint: 'Adicione 7 a ambos os lados, depois divida por 4.', level: 'medio' },
            { question: 'Quanto √© 3/4 * 2/3?', options: ['1/2', '5/12', '6/7', '9/8'], correct: '1/2', hint: 'Multiplique os numeradores e os denominadores. Simplifique a fra√ß√£o resultante.', level: 'medio' },

            // Opera√ß√µes com matrizes (adi√ß√£o)
            { question: 'Dadas A=[1 2; 3 4] e B=[5 6; 7 8], qual √© A + B?', options: ['[6 8; 10 12]', '[5 12; 21 32]', '[6 7; 8 9]', '[1 5; 3 7]'], correct: '[6 8; 10 12]', hint: 'Some os elementos correspondentes de cada matriz. A+B = [a11+b11 a12+b12; a21+b21 a22+b22]', level: 'medio' },
            { question: 'Dadas C=[2 -1; 0 3] e D=[ -2 1; 5 -3], qual √© C + D?', options: ['[0 0; 5 0]', '[4 -2; -5 6]', '[0 0; 5 6]', '[0 0; -5 0]'], correct: '[0 0; 5 0]', hint: 'Lembre-se de somar elementos com seus respectivos sinais.', level: 'dificil' },
            { question: 'Se M1=[1 0; 2 3] e M2=[4 5; 6 7], qual √© M1 + M2?', options: ['[5 5; 8 10]', '[4 0; 12 21]', '[5 6; 7 10]', '[1 4; 2 6]'], correct: '[5 5; 8 10]', hint: 'A adi√ß√£o de matrizes √© elemento por elemento.', level: 'dificil' },

            // √Ålgebra (fun√ß√µes lineares)
            { question: 'Qual √© a inclina√ß√£o (coeficiente angular) da fun√ß√£o f(x) = 3x - 7?', options: ['3', '-7', '7', '-3'], correct: '3', hint: 'A forma geral de uma fun√ß√£o linear √© y = mx + b, onde m √© a inclina√ß√£o.', level: 'medio' },
            { question: 'Qual √© o intercepto y (coeficiente linear) da fun√ß√£o f(x) = 2x + 5?', options: ['5', '2', '-5', '-2'], correct: '5', hint: 'O intercepto y √© o valor de f(x) quando x √© zero.', level: 'medio' },
            { question: 'Qual a equa√ß√£o de uma reta que passa pelos pontos (1, 2) e (3, 8)?', options: ['y = 3x - 1', 'y = 2x + 1', 'y = 3x + 1', 'y = 2x - 1'], correct: 'y = 3x - 1', hint: 'Calcule a inclina√ß√£o (m = Œîy/Œîx) e use a forma ponto-inclina√ß√£o (y - y1 = m(x - x1)).', level: 'dificil' },
            { question: 'Dada f(x) = -x + 4, qual √© o valor de f(5)?', options: ['-1', '9', '1', '-9'], correct: '-1', hint: 'Substitua x por 5 na fun√ß√£o.', level: 'facil' },

            // Derivada de fun√ß√£o polinomial
            { question: 'Qual √© a derivada de f(x) = x¬≥ + 2x?', options: ['3x¬≤ + 2', '3x¬≤ + 2x', 'x¬≤ + 2', 'x¬≥ + 2'], correct: '3x¬≤ + 2', hint: 'Use a regra da pot√™ncia: d/dx(x^n) = nx^(n-1). A derivada de uma constante vezes x √© a constante.', level: 'dificil' },
            { question: 'A derivada de g(x) = 4x¬≤ - 5x + 1 √©:', options: ['8x - 5', '4x - 5', '8x¬≤ - 5x', '4x - 5x'], correct: '8x - 5', hint: 'Aplique a regra da pot√™ncia para cada termo. A derivada de uma constante √© zero.', level: 'dificil' },
            { question: 'Qual √© a derivada de h(x) = 7?', options: ['0', '7', '1', '7x'], correct: '0', hint: 'A derivada de uma fun√ß√£o constante √© sempre zero.', level: 'professor' },
            { question: 'Derive f(x) = (x^4)/2 - 3x¬≤ + 9.', options: ['2x¬≥ - 6x', '4x¬≥ - 6x', '2x¬≥ - 3x', 'x¬≥ - 6x'], correct: '2x¬≥ - 6x', hint: 'Aplique a regra da pot√™ncia e lembre-se que a derivada de uma constante √© zero.', level: 'dificil' },

            // Integral de fun√ß√£o polinomial
            { question: 'Qual √© a integral indefinida de f(x) = 3x¬≤?', options: ['x¬≥ + C', '6x + C', 'x¬≤ + C', '3x¬≥ + C'], correct: 'x¬≥ + C', hint: 'Use a regra da pot√™ncia inversa: ‚à´x^n dx = (x^(n+1))/(n+1) + C. Lembre-se da constante de integra√ß√£o.', level: 'dificil' },
            { question: 'A integral indefinida de g(x) = 2x + 4 √©:', options: ['x¬≤ + 4x + C', '2 + C', '2x¬≤ + 4x + C', 'x¬≤ + 4 + C'], correct: 'x¬≤ + 4x + C', hint: 'Integre cada termo separadamente usando a regra da pot√™ncia e a regra da constante.', level: 'dificil' },
            { question: 'A integral de ‚à´(5x‚Å¥ - 2x) dx √©:', options: ['x‚Åµ - x¬≤ + C', '20x¬≥ - 2 + C', 'x‚Åµ - x + C', '5x‚Åµ - x¬≤ + C'], correct: 'x‚Åµ - x¬≤ + C', hint: 'Integre termo a termo. Lembre-se de somar 1 ao expoente e dividir pelo novo expoente.', level: 'dificil' },

            // Rela√ß√£o entre derivada e integral
            { question: 'Se F(x) √© a antiderivada de f(x), ent√£o d/dx [F(x)] √© igual a:', options: ['f(x)', 'F(x)', '0', 'f\'(x)'], correct: 'f(x)', hint: 'Este √© o Teorema Fundamental do C√°lculo, parte 1.', level: 'professor' },
            { question: 'A opera√ß√£o inversa da deriva√ß√£o √© a:', options: ['Integra√ß√£o', 'Multiplica√ß√£o', 'Divis√£o', 'Subtra√ß√£o'], correct: 'Integra√ß√£o', hint: 'Ambas s√£o opera√ß√µes fundamentais no c√°lculo e s√£o inversas uma da outra.', level: 'professor' },
            { question: 'Qual a rela√ß√£o entre a derivada e a integral definida de uma fun√ß√£o?', options: ['S√£o opera√ß√µes inversas', 'S√£o a mesma opera√ß√£o', 'N√£o t√™m rela√ß√£o', 'S√£o opera√ß√µes de soma'], correct: 'S√£o opera√ß√µes inversas', hint: 'O Teorema Fundamental do C√°lculo estabelece essa rela√ß√£o.', level: 'professor' },

            // Integrais indefinidas com ra√≠zes e fra√ß√µes
            { question: 'Qual √© a integral indefinida de 1/x?', options: ['ln|x| + C', 'x¬≤ + C', '-1/x¬≤ + C', '1 + C'], correct: 'ln|x| + C', hint: 'A integral de 1/x √© uma fun√ß√£o logar√≠tmica natural.', level: 'professor' },
            { question: 'A integral indefinida de ‚àöx (ou x^(1/2)) √©:', options: ['(2/3)x^(3/2) + C', '(1/2)x^(-1/2) + C', 'x^(3/2) + C', '(3/2)x^(3/2) + C'], correct: '(2/3)x^(3/2) + C', hint: 'Reescreva a raiz como uma pot√™ncia e aplique a regra da pot√™ncia inversa.', level: 'professor' },
            { question: 'Calcule ‚à´(1/‚àöx) dx', options: ['2‚àöx + C', '‚àöx + C', '-1/(2‚àöx) + C', '1/(2‚àöx) + C'], correct: '2‚àöx + C', hint: 'Reescreva como x^(-1/2) e use a regra da pot√™ncia.', level: 'professor' },

            // C√°lculo de velocidade a partir da fun√ß√£o posi√ß√£o
            { question: 'Se a fun√ß√£o posi√ß√£o de um objeto √© s(t) = t¬≥ + 2t, qual √© a fun√ß√£o velocidade v(t)?', options: ['3t¬≤ + 2', 't¬≤ + 2', '3t + 2', 't¬≥ + 2'], correct: '3t¬≤ + 2', hint: 'A velocidade √© a derivada da fun√ß√£o posi√ß√£o em rela√ß√£o ao tempo.', level: 'professor' },
            { question: 'A fun√ß√£o posi√ß√£o de uma part√≠cula √© s(t) = 5t¬≤ - 10t. Qual a velocidade da part√≠cula em t = 2 segundos?', options: ['10 m/s', '0 m/s', '20 m/s', '5 m/s'], correct: '10 m/s', hint: 'Derive a fun√ß√£o posi√ß√£o para obter a fun√ß√£o velocidade e substitua t=2.', level: 'professor' },

            // Reta tangente √† hip√©rbole (ou outras curvas, exemplo mais simples)
            { question: 'Qual √© a inclina√ß√£o da reta tangente √† curva y = x¬≤ no ponto (2, 4)?', options: ['4', '2', '8', '6'], correct: '4', hint: 'Derive a fun√ß√£o y = x¬≤ e substitua o valor de x do ponto.', level: 'professor' },
            { question: 'Encontre a equa√ß√£o da reta tangente √† curva y = x¬≥ no ponto (1, 1).', options: ['y = 3x - 2', 'y = x + 0', 'y = 3x + 2', 'y = 2x - 1'], correct: 'y = 3x - 2', hint: 'Derive a fun√ß√£o para encontrar a inclina√ß√£o, depois use a forma ponto-inclina√ß√£o da reta.', level: 'professor' },

            // C√°lculo de velocidade e acelera√ß√£o em fun√ß√£o do tempo
            { question: 'Se a velocidade de um carro √© v(t) = 4t + 5, qual √© a acelera√ß√£o a(t)?', options: ['4', '5', '4t', '4t + 5'], correct: '4', hint: 'A acelera√ß√£o √© a derivada da fun√ß√£o velocidade em rela√ß√£o ao tempo.', level: 'professor' },
            { question: 'Dada a posi√ß√£o s(t) = t¬≤ + 3t, qual a acelera√ß√£o em t=1?', options: ['2', '5', '1', '4'], correct: '2', hint: 'Derive s(t) para obter v(t), e derive v(t) para obter a(t). A acelera√ß√£o de uma fun√ß√£o quadr√°tica como essa √© constante.', level: 'professor' },

            // Taxa de varia√ß√£o da √°rea de um quadrado em crescimento
            { question: 'Se o lado de um quadrado √© L e est√° aumentando a uma taxa de 2 cm/s, qual a taxa de varia√ß√£o da √°rea (dA/dt) quando L = 5 cm?', options: ['20 cm¬≤/s', '10 cm¬≤/s', '25 cm¬≤/s', '4 cm¬≤/s'], correct: '20 cm¬≤/s', hint: 'A √°rea A = L¬≤. Use a regra da cadeia: dA/dt = (dA/dL) * (dL/dt).', level: 'professor' },
            { question: 'A √°rea de um quadrado √© A = L¬≤. Se o lado aumenta a uma taxa de 3 cm/s, qual a taxa de varia√ß√£o da √°rea quando o lado √© 10 cm?', options: ['60 cm¬≤/s', '30 cm¬≤/s', '100 cm¬≤/s', '6 cm¬≤/s'], correct: '60 cm¬≤/s', hint: 'Derive a √°rea em rela√ß√£o ao tempo usando a regra da cadeia.', level: 'professor' }
        ];

        // Mapeia a dificuldade √† quantidade de quest√µes e ao tempo adicional da dica
        const DIFFICULTY_SETTINGS = {
            'facil': { numQuestions: 5, hintTimeBonus: 5, levels: ['facil'] },
            'medio': { numQuestions: 10, hintTimeBonus: 7, levels: ['facil', 'medio'] }, 
            'dificil': { numQuestions: 20, hintTimeBonus: 10, levels: ['facil', 'medio', 'dificil'] },
            'professor': { numQuestions: 5, hintTimeBonus: 15, levels: ['professor'] } 
        };
        const BASE_TIME_PER_QUESTION = 10; // Segundos iniciais
        const MAX_RANKING_ENTRIES = 10; // Limite de entradas no ranking

        // --- VARI√ÅVEIS DE ESTADO DO JOGO ---
        let currentQuestionIndex = 0;
        let timerInterval;
        let shuffledQuestions = [];
        let score = 0;
        let proceedingToNextQuestion = false; // Flag para controlar a transi√ß√£o
        let playerName = 'Jogador'; // Nome padr√£o
        let gameStartTime; // Para calcular o tempo total do jogo
        let currentDifficulty = 'facil'; // Dificuldade atual do jogo
        let hintUsedForCurrentQuestion = false; // Flag para saber se a dica foi usada na quest√£o atual
        let timeLeftOnTimer = BASE_TIME_PER_QUESTION; // Vari√°vel para controlar o tempo restante do timer
        let lastPlayerName = ''; // Para armazenar o nome do √∫ltimo jogador
        let isAdminMode = false; // NOVA VARI√ÅVEL: Controla o modo admin
        let adminKeySequence = []; // Para a sequ√™ncia da senha do admin

        // --- ELEMENTOS DO DOM E MODAIS BOOTSTRAP ---
        const startScreen = document.getElementById('startScreen');
        const nameModalEl = document.getElementById('nameModal');
        const confirmPlayerModalEl = document.getElementById('confirmPlayerModal'); // Novo modal de confirma√ß√£o
        const difficultyModalEl = document.getElementById('difficultyModal');
        const questionModalEl = document.getElementById('questionModal');
        const hintModalEl = document.getElementById('hintModal');
        const resultModalEl = document.getElementById('resultModal');
        const rankingModalEl = document.getElementById('rankingModal');
        const adminModeAlert = document.getElementById('adminModeAlert'); // Elemento do alerta admin

        const nameModal = new bootstrap.Modal(nameModalEl);
        const confirmPlayerModal = new bootstrap.Modal(confirmPlayerModalEl); // Novo modal de confirma√ß√£o
        const difficultyModal = new bootstrap.Modal(difficultyModalEl);
        const questionModal = new bootstrap.Modal(questionModalEl);
        const hintModal = new bootstrap.Modal(hintModalEl);
        const resultModal = new bootstrap.Modal(resultModalEl);
        const rankingModal = new bootstrap.Modal(rankingModalEl);

        const playerNameInput = document.getElementById('playerNameInput');
        const continueToDifficultyBtn = document.getElementById('continueToDifficultyBtn');
        const lastPlayerNameText = document.getElementById('lastPlayerNameText'); // Elemento para mostrar o √∫ltimo nome
        const changePlayerNameBtn = document.getElementById('changePlayerNameBtn'); // Bot√£o para mudar nome
        const continueWithLastPlayerBtn = document.getElementById('continueWithLastPlayerBtn'); // Bot√£o para continuar com √∫ltimo nome
        const difficultyButtons = document.querySelectorAll('#difficultyModal .btn-lg'); // Bot√µes de dificuldade
        const questionCountEl = document.getElementById('questionCount');
        const questionTextEl = document.getElementById('questionText');
        const answersContainerEl = document.getElementById('answersContainer');
        const timerBarEl = document.getElementById('timerBar');
        const hintButton = document.getElementById('hintButton');
        const hintTextEl = document.getElementById('hintText');
        
        const resultIconEl = document.getElementById('resultIcon');
        const resultTitleEl = document.getElementById('resultTitle');
        const resultMessageEl = document.getElementById('resultMessage');
        const rankingTableBody = document.getElementById('rankingTableBody');
        
        // --- LISTENERS DE EVENTOS ---

        // Evento que dispara AP√ìS o modal da pergunta ser completamente escondido
        questionModalEl.addEventListener('hidden.bs.modal', () => {
            if (proceedingToNextQuestion) {
                proceedingToNextQuestion = false; // Reseta a flag
                showQuestion();
            }
        });

        // Evento AP√ìS o modal do ranking ser completamente escondido
        rankingModalEl.addEventListener('hidden.bs.modal', () => {
            startScreen.classList.remove('d-none'); // Reexibe a tela inicial
        });

        // Evento para continuar do modal de nome para o modal de dificuldade
        continueToDifficultyBtn.addEventListener('click', () => {
            const inputName = playerNameInput.value.trim();
            if (inputName) {
                playerName = inputName;
                localStorage.setItem('lastPlayerName', playerName); // Salva o nome como √∫ltimo jogador
                nameModal.hide();
                difficultyModal.show(); // Mostra o modal de dificuldade
            } else {
                alert('Por favor, digite seu nome para continuar!');
                playerNameInput.focus();
            }
        });

        // Eventos para o modal de confirma√ß√£o do √∫ltimo jogador
        changePlayerNameBtn.addEventListener('click', () => {
            confirmPlayerModal.hide();
            playerNameInput.value = ''; // Limpa o campo para novo nome
            nameModal.show(); // Volta para o modal de nome para o usu√°rio digitar um novo nome
            playerNameInput.focus();
        });

        continueWithLastPlayerBtn.addEventListener('click', () => {
            playerName = lastPlayerName; // Usa o nome do √∫ltimo jogador
            confirmPlayerModal.hide();
            difficultyModal.show(); // Vai direto para o modal de dificuldade
        });


        // Eventos para os bot√µes de dificuldade
        difficultyButtons.forEach(button => {
            button.addEventListener('click', (event) => {
                currentDifficulty = event.target.dataset.difficulty;
                difficultyModal.hide();
                startGame(); // Inicia o jogo ap√≥s a sele√ß√£o de dificuldade
            });
        });

        // Evento do bot√£o de dica
        hintButton.addEventListener('click', () => {
            if (hintUsedForCurrentQuestion) return; // N√£o permite usar a dica mais de uma vez
            
            const currentQuestion = shuffledQuestions[currentQuestionIndex];
            if (currentQuestion && currentQuestion.hint) {
                hintTextEl.textContent = currentQuestion.hint;
                hintModal.show();
                hintUsedForCurrentQuestion = true; // Marca a dica como usada
                hintButton.disabled = true; // Desabilita o bot√£o de dica

                // Aumenta o tempo restante da quest√£o
                clearInterval(timerInterval); // Para o timer atual
                const timeBonus = DIFFICULTY_SETTINGS[currentDifficulty].hintTimeBonus;
                timeLeftOnTimer += timeBonus;
                // Limita o tempo m√°ximo para n√£o se tornar excessivo
                const maxTime = BASE_TIME_PER_QUESTION + timeBonus;
                if (timeLeftOnTimer > maxTime) {
                    timeLeftOnTimer = maxTime;
                }
                startTimer(timeLeftOnTimer); // Reinicia o timer com o tempo extra
            } else {
                alert('N√£o h√° dica dispon√≠vel para esta quest√£o.');
            }
        });

        // LISTENER PARA O MODO ADMIN
        document.addEventListener('keydown', (event) => {
            adminKeySequence.push(event.key.toLowerCase());
            // Mant√©m a sequ√™ncia com os √∫ltimos 5 caracteres para "admin"
            if (adminKeySequence.length > 5) {
                adminKeySequence.shift(); 
            }

            if (adminKeySequence.join('') === 'admin') {
                isAdminMode = !isAdminMode; // Alterna o modo admin
                adminKeySequence = []; // Reseta a sequ√™ncia
                
                adminModeAlert.textContent = isAdminMode ? 'Modo Admin Ativado!' : 'Modo Admin Desativado!';
                adminModeAlert.classList.add('show');
                setTimeout(() => {
                    adminModeAlert.classList.remove('show');
                }, 2000); 
            }
        });


        // --- L√ìGICA DO JOGO ---

        function showNameModal() {
            startScreen.classList.add('d-none');
            lastPlayerName = localStorage.getItem('lastPlayerName');

            if (lastPlayerName) {
                lastPlayerNameText.textContent = lastPlayerName;
                confirmPlayerModal.show(); // Mostra modal de confirma√ß√£o
            } else {
                playerNameInput.value = ''; // Limpa o campo do nome
                nameModal.show(); // Mostra modal de nome
                playerNameInput.focus();
            }
        }

        function startGame() {
            const numQuestionsForLevel = DIFFICULTY_SETTINGS[currentDifficulty].numQuestions;
            const allowedLevels = DIFFICULTY_SETTINGS[currentDifficulty].levels;
            
            let availableQuestions = allQuestions.filter(q => allowedLevels.includes(q.level));

            availableQuestions.sort(() => Math.random() - 0.5);

            shuffledQuestions = availableQuestions.slice(0, numQuestionsForLevel);

            if (shuffledQuestions.length < numQuestionsForLevel) {
                console.warn(`Aten√ß√£o: N√£o h√° quest√µes suficientes para a dificuldade "${currentDifficulty}". Apenas ${shuffledQuestions.length} quest√µes dispon√≠veis.`);
            }

            currentQuestionIndex = 0;
            score = 0;
            gameStartTime = Date.now(); // Inicia o cron√¥metro do jogo
            hintUsedForCurrentQuestion = false; // Reseta para a nova partida

            showQuestion();
        }

        function showQuestion() {
            // Se n√£o houver quest√µes embaralhadas, ou se j√° passamos por todas
            if (!shuffledQuestions || currentQuestionIndex >= shuffledQuestions.length) {
                // Fim do jogo - Vit√≥ria
                const gameEndTime = Date.now();
                const totalTimeSeconds = ((gameEndTime - gameStartTime) / 1000).toFixed(2);
                showResult(true, score, shuffledQuestions.length, totalTimeSeconds); 
                return;
            }

            const q = shuffledQuestions[currentQuestionIndex];
            questionCountEl.textContent = `${currentQuestionIndex + 1} / ${shuffledQuestions.length}`;
            questionTextEl.textContent = q.question;
            answersContainerEl.innerHTML = '';
            hintButton.disabled = false; // Habilita o bot√£o de dica para a nova quest√£o
            hintUsedForCurrentQuestion = false; // Reseta a flag da dica para a nova quest√£o

            // Embaralha as op√ß√µes de resposta
            const shuffledOptions = [...q.options].sort(() => Math.random() - 0.5);
            shuffledOptions.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add('btn', 'btn-outline-light', 'answer-btn');
                button.onclick = () => checkAnswer(option, q.correct, button);
                answersContainerEl.appendChild(button);

                // NOVO: Destaca a resposta correta em modo admin
                if (isAdminMode && option === q.correct) {
                    button.classList.add('btn-success'); // Marca o bot√£o correto em verde
                    button.classList.remove('btn-outline-light'); // Remove o estilo de outline
                }
            });
            
            questionModal.show();
            startTimer(BASE_TIME_PER_QUESTION); // Inicia o timer com o tempo base
        }

        function checkAnswer(selectedAnswer, correctAnswer, button) {
            clearInterval(timerInterval);
            
            // Desabilita todos os bot√µes para evitar cliques m√∫ltiplos
            const answerButtons = answersContainerEl.querySelectorAll('.btn');
            answerButtons.forEach(btn => btn.disabled = true);
            hintButton.disabled = true; // Desabilita a dica ao responder

            if (selectedAnswer === correctAnswer) {
                if (!isAdminMode) {
                    button.classList.remove('btn-outline-light');
                    button.classList.add('btn-success');
                }
                score++;
                currentQuestionIndex++;
                proceedingToNextQuestion = true; 
                
                setTimeout(() => {
                    questionModal.hide(); 
                }, 1000);

            } else {
                if (!isAdminMode) {
                    button.classList.remove('btn-outline-light');
                    button.classList.add('btn-danger');
                    
                    answerButtons.forEach(btn => {
                        if (btn.textContent === correctAnswer) {
                            btn.classList.remove('btn-outline-light');
                            btn.classList.add('btn-success');
                        }
                    });
                }

                setTimeout(() => {
                    questionModal.hide();
                    const gameEndTime = Date.now();
                    const totalTimeSeconds = ((gameEndTime - gameStartTime) / 1000).toFixed(2);
                    showResult(false, score, shuffledQuestions.length, totalTimeSeconds, 'Resposta errada!'); 
                }, 1500);
            }
        }

        function startTimer(duration) {
            timeLeftOnTimer = duration; // Define o tempo inicial do timer
            timerBarEl.style.width = '100%';
            timerBarEl.className = 'progress-bar bg-primary'; // Reseta as cores
            
            timerInterval = setInterval(() => {
                timeLeftOnTimer--;
                const percentage = (timeLeftOnTimer / duration) * 100;
                timerBarEl.style.width = `${percentage}%`;

                if (percentage < 50 && percentage > 20) {
                    timerBarEl.classList.remove('bg-primary');
                    timerBarEl.classList.add('bg-warning');
                } else if(percentage <= 20) {
                    timerBarEl.classList.remove('bg-warning');
                    timerBarEl.classList.add('bg-danger');
                }

                if (timeLeftOnTimer <= 0) {
                    clearInterval(timerInterval);
                    questionModal.hide();
                    const gameEndTime = Date.now();
                    const totalTimeSeconds = ((gameEndTime - gameStartTime) / 1000).toFixed(2);
                    showResult(false, score, shuffledQuestions.length, totalTimeSeconds, 'O tempo acabou!'); 
                }
            }, 1000);
        }
        
        function showResult(isSuccess, finalScore, totalQuestionsAttempted, totalTime, message = '') {
            clearInterval(timerInterval); // Garante que o timer seja parado
            
            if (isSuccess) {
                resultIconEl.textContent = 'üéâ';
                resultTitleEl.textContent = 'Bomba Desarmada!';
                resultMessageEl.textContent = `Parab√©ns, ${playerName}! Voc√™ acertou ${finalScore} de ${totalQuestionsAttempted} quest√µes em ${totalTime} segundos no n√≠vel ${currentDifficulty.charAt(0).toUpperCase() + currentDifficulty.slice(1)}!`;
                resultTitleEl.classList.remove('text-danger');
                resultTitleEl.classList.add('text-success');
                launchConfetti();
            } else {
                document.body.classList.add('explode-animation');
                resultIconEl.textContent = 'üí•';
                resultTitleEl.textContent = 'BOOM!';
                resultMessageEl.textContent = `${message} Voc√™ acertou ${finalScore} de ${totalQuestionsAttempted} quest√µes no n√≠vel ${currentDifficulty.charAt(0).toUpperCase() + currentDifficulty.slice(1)}.`;
                resultTitleEl.classList.remove('text-success');
                resultTitleEl.classList.add('text-danger');
            }

            if (gameStartTime) { 
                saveRankingEntry(playerName, finalScore, totalQuestionsAttempted, totalTime, currentDifficulty);
            }

            resultModal.show();
        }
        
        function restartGame() {
            resultModal.hide();
            document.body.classList.remove('explode-animation');
            showNameModal(); 
        }

        function getRanking() {
            const ranking = localStorage.getItem('bombRanking');
            return ranking ? JSON.parse(ranking) : [];
        }

        function saveRankingEntry(name, score, totalQuestions, time, difficulty) {
            let ranking = getRanking();
            const newEntry = {
                name: name,
                score: score,
                totalQuestions: totalQuestions,
                time: parseFloat(time), 
                difficulty: difficulty,
                date: new Date().toISOString()
            };

            const existingEntryIndex = ranking.findIndex(
                entry => entry.name === name && entry.difficulty === difficulty
            );

            if (existingEntryIndex > -1) {
           
                const existingEntry = ranking[existingEntryIndex];
              
                if (newEntry.score > existingEntry.score || 
                    (newEntry.score === existingEntry.score && newEntry.time < existingEntry.time)) {
                    ranking[existingEntryIndex] = newEntry; 
                    console.log(`Ranking atualizado para ${name} no n√≠vel ${difficulty}: Melhor tempo/score!`);
                } else {
                    console.log(`Resultado de ${name} no n√≠vel ${difficulty} n√£o √© melhor que o existente. N√£o atualizado.`);
                }
            } else {
                ranking.push(newEntry);
                console.log(`Nova entrada no ranking para ${name} no n√≠vel ${difficulty}.`);
            }

            sortRanking(ranking);

            if (ranking.length > MAX_RANKING_ENTRIES) {
                ranking = ranking.slice(0, MAX_RANKING_ENTRIES);
            }

            localStorage.setItem('bombRanking', JSON.stringify(ranking));
        }

        // Fun√ß√£o auxiliar para ordenar o ranking
        function sortRanking(rankingArray) {
            // A ordem de prioridade das dificuldades para ordena√ß√£o do ranking
            const difficultyOrder = ['professor', 'dificil', 'medio', 'facil'];

            rankingArray.sort((a, b) => {
                // 1. Por Dificuldade (professor > dificil > medio > facil)
                const diffA = difficultyOrder.indexOf(a.difficulty);
                const diffB = difficultyOrder.indexOf(b.difficulty);
                if (diffA !== diffB) {
                    return diffA - diffB;
                }

                // 2. Por Score (maior primeiro)
                if (b.score !== a.score) {
                    return b.score - a.score;
                }

                // 3. Por Tempo (menor primeiro)
                return a.time - b.time;
            });
        }


        // Fun√ß√£o para exibir o modal do ranking
        function showRanking() {
            let ranking = getRanking();
            rankingTableBody.innerHTML = ''; // Limpa a tabela

            if (ranking.length === 0) {
                rankingTableBody.innerHTML = '<tr><td colspan="6" class="text-center">Nenhum recorde ainda. Seja o primeiro a desarmar uma bomba!</td></tr>';
            } else {
                // Garante que o ranking est√° ordenado antes de exibir
                sortRanking(ranking); 
                
                // Exibe as entradas at√© o limite definido em MAX_RANKING_ENTRIES
                const entriesToDisplay = ranking.slice(0, MAX_RANKING_ENTRIES);
                entriesToDisplay.forEach((entry, index) => {
                    const row = rankingTableBody.insertRow();
                    // A classe 'completed-game' aqui √© apenas visual, para destacar
                    // Se voc√™ quiser diferenciar jogos ganhos de perdidos no ranking,
                    // voc√™ precisaria salvar um status de 'isSuccess' na entrada do ranking.
                    row.classList.add('completed-game'); 
                    row.innerHTML = `
                        <th scope="row">${index + 1}</th>
                        <td>${entry.name}</td>
                        <td>${entry.score}</td>
                        <td>${entry.totalQuestions}</td>
                        <td>${entry.time.toFixed(2)}s</td>
                        <td>${entry.difficulty.charAt(0).toUpperCase() + entry.difficulty.slice(1)}</td>
                    `;
                });
            }
            // Garante que a tela inicial esteja escondida e mostra o modal do ranking
            startScreen.classList.add('d-none'); // Esconde a tela inicial
            nameModal.hide();
            confirmPlayerModal.hide();
            difficultyModal.hide();
            questionModal.hide();
            hintModal.hide();
            resultModal.hide();
            
            rankingModal.show();
        }

        function showRankingFromResults() {
            resultModal.hide(); // Esconde o modal de resultados
            showRanking(); // Chama a fun√ß√£o que popula e mostra o ranking
        }

        // Fun√ß√£o para apagar todos os dados do localStorage
        function clearAllData() {
            if (confirm('Tem certeza que deseja apagar todos os dados do ranking e o √∫ltimo nome salvo? Esta a√ß√£o √© irrevers√≠vel.')) {
                localStorage.removeItem('bombRanking');
                localStorage.removeItem('lastPlayerName');
                alert('Todos os dados foram apagados com sucesso!');
                // Opcional: recarregar a p√°gina para garantir que tudo esteja limpo
                location.reload(); 
            }
        }

        // --- EFEITOS VISUAIS ---
        function launchConfetti() {
            const duration = 2 * 1000;
            const animationEnd = Date.now() + duration;
            const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 1056 }; // zIndex maior que o do modal

            function randomInRange(min, max) {
                return Math.random() * (max - min) + min;
            }

            const interval = setInterval(function() {
                const timeLeft = animationEnd - Date.now();

                if (timeLeft <= 0) {
                    return clearInterval(interval);
                }

                const particleCount = 50 * (timeLeft / duration);
                // Lan√ßa confetes de ambos os lados da tela
                confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } });
                confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } });

            }, 250);
        }

    </script>
</body>
</html>