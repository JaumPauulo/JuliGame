<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Desarme a Bomba Matem√°tica 2.0</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        /* Estilos personalizados para aprimorar o visual do jogo */
        :root {
            --primary-color: #ff4757; /* Vermelho vibrante */
            --dark-bg: #1a1a2e; /* Azul escuro profundo */
            --light-bg: #1f1f3a; /* Azul escuro ligeiramente mais claro */
            --text-color: #e0e0e0; /* Cinza claro para o texto */
            --success-color: #2ecc71; /* Verde para sucesso */
            --info-color: #3498db; /* Azul para informa√ß√µes/dicas */
            --font-family: 'Poppins', sans-serif;
            --border-color: #333; /* Cor para bordas sutis */
        }

        body {
            background-color: var(--dark-bg);
            color: var(--text-color);
            font-family: var(--font-family);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            overflow: hidden; /* Evita barras de rolagem durante anima√ß√µes */
        }

        .game-container {
            background-color: var(--light-bg);
            border-radius: 15px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            border: 2px solid var(--primary-color);
            transition: transform 0.3s ease;
            position: relative; 
        }

        .btn-start {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            padding: 12px 30px;
            border-radius: 50px;
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 4px 15px rgba(255, 71, 87, 0.4);
        }

        .btn-start:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(255, 71, 87, 0.6);
        }

        /* Estilos para os Modais do Bootstrap */
        .modal-content {
            background-color: var(--light-bg);
            border: 1px solid var(--primary-color);
            border-radius: 15px;
        }

        .modal-header, .modal-footer {
            border-bottom: 1px solid var(--border-color);
            border-top: 1px solid var(--border-color);
        }
        
        .modal-title {
            color: var(--primary-color);
            font-weight: 700;
        }
        .modal-header .btn-close {
            filter: invert(1); /* Deixa o X branco */
        }


        .answer-btn {
            width: 100%;
            margin: 8px 0;
            font-size: 1.1rem;
        }
        
        .progress-bar {
            background-color: var(--primary-color);
            transition: width 1s linear !important;
        }

        /* Anima√ß√£o de Explos√£o Melhorada */
        @keyframes screen-shake {
            0% { transform: translate(0, 0) rotate(0); }
            10%, 30%, 50%, 70%, 90% { transform: translate(-5px, 5px) rotate(-1deg); }
            20%, 40%, 60%, 80% { transform: translate(5px, -5px) rotate(1deg); }
            100% { transform: translate(0, 0) rotate(0); }
        }

        .explode-animation {
            animation: screen-shake 0.5s ease-in-out;
        }

        /* Estilos para o Ranking */
        .ranking-table {
            color: var(--text-color);
        }
        .ranking-table th {
            color: var(--primary-color);
        }
        .ranking-table tbody tr:nth-child(odd) {
            background-color: rgba(0, 0, 0, 0.2);
        }
        .ranking-table tbody tr:hover {
            background-color: rgba(255, 71, 87, 0.1);
        }
        .ranking-table .completed-game {
            background-color: rgba(46, 204, 113, 0.2) !important; /* Sucesso */
            font-weight: bold;
        }

        /* Cores dos bot√µes de dificuldade personalizados */
        .btn-difficulty {
            background-color: var(--light-bg); /* Fundo padr√£o do container */
            color: var(--primary-color); /* Texto vermelho */
            border: 2px solid var(--primary-color); /* Borda vermelha */
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        .btn-difficulty:hover {
            background-color: var(--primary-color); /* Fundo vermelho no hover */
            color: white; /* Texto branco no hover */
            border-color: var(--primary-color); /* Borda vermelha no hover */
        }
        /* Cor espec√≠fica para o n√≠vel professor */
        .btn-difficulty[data-difficulty="professor"] {
            color: var(--info-color);
            border-color: var(--info-color);
        }
        .btn-difficulty[data-difficulty="professor"]:hover {
            background-color: var(--info-color);
            color: white;
        }

        /* Bot√µes de op√ß√£o de resposta */
        .answer-btn.btn-outline-light {
            border-color: var(--text-color);
            color: var(--text-color);
        }
        .answer-btn.btn-outline-light:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Estilo para o bot√£o de apagar dados mais discreto e fora do modal */
        .btn-clear-data {
            position: fixed; /* Posi√ß√£o fixa na viewport */
            bottom: 15px;
            right: 15px; /* Posicionado no canto inferior direito */
            font-size: 1.8rem; /* Tamanho maior para o √≠cone */
            padding: 5px 10px;
            background: transparent;
            color: rgba(255, 255, 255, 0.3); /* Mais discreto */
            border: none; /* Sem borda inicial */
            border-radius: 5px;
            transition: all 0.3s ease;
            cursor: pointer;
            z-index: 1000; /* Garante que esteja acima de outros elementos, mas abaixo dos modais */
        }
        .btn-clear-data:hover {
            color: var(--primary-color);
            transform: scale(1.1); /* Um pequeno zoom no hover */
            background-color: rgba(255, 71, 87, 0.05); /* Fundo sutil no hover */
        }

        /* Estilo para o alerta de modo admin */
        .admin-alert {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #2ecc71; /* Verde */
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: bold;
            z-index: 1060; /* Acima de outros modais */
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .admin-alert.show {
            opacity: 1;
        }
    </style>
</head>
<body>

    <div class="game-container" id="startScreen">
        <h1 class="display-4 fw-bold text-danger mb-3">Desarme a Bomba üí£</h1>
        <p class="lead mb-4">Responda corretamente antes que o tempo se esgote para evitar a explos√£o!</p>
        <div class="d-grid gap-3 col-8 mx-auto mt-4"> <button class="btn btn-start btn-lg" onclick="showNameModal()">Iniciar Jogo</button>
            <button class="btn btn-outline-light btn-lg" onclick="showRanking()">Ver Ranking</button>
        </div>
    </div>

    <button class="btn btn-clear-data" onclick="clearAllData()" title="Apagar todos os dados salvos">üóëÔ∏è</button>

    <div id="adminModeAlert" class="admin-alert">
        Modo Admin Ativado!
    </div>

    <div class="modal fade" id="nameModal" tabindex="-1" aria-labelledby="nameModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="nameModalLabel">Qual o seu nome?</h5>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="playerNameInput" class="form-label">Nome:</label>
                        <input type="text" class="form-control" id="playerNameInput" placeholder="Digite seu nome aqui" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="continueToDifficultyBtn">Continuar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirmPlayerModal" tabindex="-1" aria-labelledby="confirmPlayerModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmPlayerModalLabel">Bem-vindo(a) de volta!</h5>
                </div>
                <div class="modal-body">
                    <p class="lead">Deseja continuar como <strong id="lastPlayerNameText"></strong>?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="changePlayerNameBtn">Mudar Nome</button>
                    <button type="button" class="btn btn-primary" id="continueWithLastPlayerBtn">Sim, continuar!</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="difficultyModal" tabindex="-1" aria-labelledby="difficultyModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="difficultyModalLabel">Escolha a Dificuldade</h5>
                </div>
                <div class="modal-body d-grid gap-3">
                    <button class="btn btn-lg btn-difficulty" data-difficulty="facil">F√°cil (5 quest√µes)</button>
                    <button class="btn btn-lg btn-difficulty" data-difficulty="medio">M√©dio (10 quest√µes)</button>
                    <button class="btn btn-lg btn-difficulty" data-difficulty="dificil">Dif√≠cil (20 quest√µes)</button>
                    <button class="btn btn-lg btn-difficulty" data-difficulty="professor">N√≠vel Professor (5 quest√µes avan√ßadas)</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="questionModal" tabindex="-1" aria-labelledby="questionModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="questionModalLabel">Quest√£o <span id="questionCount"></span></h5>
                    <button class="btn btn-info btn-sm ms-auto" id="hintButton">Dica</button>
                </div>
                <div class="modal-body">
                    <p class="lead fs-4" id="questionText"></p>
                    <div class="d-grid gap-2" id="answersContainer">
                        </div>
                    <div class="progress mt-4" style="height: 10px;">
                        <div id="timerBar" class="progress-bar" role="progressbar" style="width: 100%;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="hintModal" tabindex="-1" aria-labelledby="hintModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="hintModalLabel">Dica! ü§î</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <p id="hintText"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Entendi!</button>
                </div>
            </div>
        </div>
    </div>


    <div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-center">
                <div class="modal-body p-5">
                    <h2 class="display-3" id="resultIcon"></h2>
                    <h3 class="my-3" id="resultTitle"></h3>
                    <p class="lead" id="resultMessage"></p>
                    <button class="btn btn-start mt-3" onclick="restartGame()">Jogar Novamente</button>
                    <button class="btn btn-outline-info mt-3 ms-2" onclick="showRankingFromResults()">Ver Ranking</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="rankingModal" tabindex="-1" aria-labelledby="rankingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="rankingModalLabel">Ranking dos Melhores Desarmadores üèÜ</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-hover ranking-table">
                        <thead>
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">Nome</th>
                                <th scope="col">Acertos</th>
                                <th scope="col">Total</th>
                                <th scope="col">Tempo</th>
                                <th scope="col">Dificuldade</th>
                            </tr>
                        </thead>
                        <tbody id="rankingTableBody">
                            </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- CONFIGURA√á√ïES DO JOGO ---
        const allQuestions = [
    // ========== √ÅLGEBRA B√ÅSICA ==========
    { question: 'Se 3x + 5 = 17, qual √© o valor de x?', options: ['4', '3', '5', '6'], correct: '4', hint: 'Subtraia 5 de ambos os lados e depois divida por 3.', level: 'facil' },
    { question: 'Resolva a equa√ß√£o: 2(y - 3) = 10', options: ['8', '7', '9', '11'], correct: '8', hint: 'Divida por 2 primeiro, depois adicione 3.', level: 'medio' },
    { question: 'Quanto √© 1/2 + 1/3?', options: ['5/6', '2/5', '1/6', '3/5'], correct: '5/6', hint: 'MMC de 2 e 3 √© 6. (3/6 + 2/6 = 5/6)', level: 'facil' },
    
    // ========== MATRIZES & OPERA√á√ïES ==========
    { question: 'Dadas A = [[1,2],[3,4]] e B = [[5,6],[7,8]], qual √© A + B?', options: ['[[6,8],[10,12]]', '[[5,12],[21,32]]', '[[6,7],[8,9]]', '[[1,5],[3,7]]'], correct: '[[6,8],[10,12]]', hint: 'Some elementos correspondentes: a‚ÇÅ‚ÇÅ+b‚ÇÅ‚ÇÅ, a‚ÇÅ‚ÇÇ+b‚ÇÅ‚ÇÇ, etc.', level: 'facil' },
    { question: 'Qual o resultado de [[2,-1],[0,3]] √ó [[1],[4]]?', options: ['[[-2],[12]]', '[[2],[-4]]', '[[6],[12]]', '[[1],[7]]'], correct: '[[-2],[12]]', hint: 'Multiplica√ß√£o linha por coluna: (2*1 + (-1)*4) e (0*1 + 3*4)', level: 'medio' },
    { question: 'Qual o determinante de [[3,1],[2,4]]?', options: ['10', '14', '5', '12'], correct: '10', hint: 'det = (a*d) - (b*c) = (3*4) - (1*2)', level: 'medio' },
    { question: 'Calcule o determinante de [[1,2,3],[0,4,5],[1,0,6]]', options: ['22', '10', '-14', '18'], correct: '22', hint: 'Regra de Sarrus: (1*4*6 + 2*5*1 + 3*0*0) - (3*4*1 + 1*5*0 + 2*0*6)', level: 'dificil' },
    
    // ========== SISTEMAS LINEARES & CRAMER ==========
    { question: 'Resolva o sistema: {2x + y = 5; x - y = 1}', options: ['(2,1)', '(3,1)', '(1,3)', '(2,3)'], correct: '(2,1)', hint: 'Some as equa√ß√µes para eliminar y: 3x = 6', level: 'medio' },
    { question: 'Para o sistema {3x+2y=8; x-4y=-6}, qual √© D_y no m√©todo de Cramer?', options: ['30', '14', '-18', '22'], correct: '30', hint: 'D_y = det([[3,8],[1,-6]]) = (3*-6) - (8*1)', level: 'dificil' },
    { question: 'Resolva por Cramer: {x+y+z=6; 2y+5z=-4; 2x+5y-z=27}', options: ['(5,3,-2)', '(4,2,-1)', '(6,0,-2)', '(3,5,-2)'], correct: '(5,3,-2)', hint: 'Calcule D, D_x, D_y, D_z usando determinantes', level: 'professor' },
    { question: 'Uma loja vende A (R$15) e B (R$25). Foram vendidas 40 unidades com total R$800. Quantas de A?', options: ['20', '25', '30', '15'], correct: '20', hint: 'Sistema: {A + B = 40; 15A + 25B = 800}', level: 'dificil' },
    
    // ========== DERIVADAS ==========
    { question: 'Qual a derivada de f(x) = x¬≥ + 2x?', options: ['3x¬≤ + 2', '3x¬≤ + 2x', 'x¬≤ + 2', 'x¬≥ + 2'], correct: '3x¬≤ + 2', hint: 'Regra da pot√™ncia: d/dx(x^n) = nx^{n-1}', level: 'medio' },
    { question: 'Derive f(x) = (x¬≤ + 1)(3x - 2)', options: ['9x¬≤ - 4x + 3', '6x¬≤ - 2x + 3', '3x¬≥ - 2x + 3', '9x¬≤ + 4x - 3'], correct: '9x¬≤ - 4x + 3', hint: 'Regra do produto: (uv)\' = u\'v + uv\'', level: 'dificil' },
    { question: 'Derive f(x) = ‚àö(3x¬≤ + 1)', options: ['3x/‚àö(3x¬≤+1)', '6x/‚àö(3x¬≤+1)', '3/‚àö(3x¬≤+1)', 'x/‚àö(3x¬≤+1)'], correct: '3x/‚àö(3x¬≤+1)', hint: 'Regra da cadeia: d/dx[g(h(x))] = g\'(h(x))¬∑h\'(x)', level: 'professor' },
    { question: 'Qual a inclina√ß√£o da tangente a y = x¬≤ no ponto (2,4)?', options: ['4', '2', '1', '0'], correct: '4', hint: 'Derivada dy/dx = 2x. Avalie em x=2', level: 'dificil' },
    { question: 'Se V(t) = t¬≥ - 4t (m/s) √© a velocidade, qual a acelera√ß√£o em t=2s?', options: ['8 m/s¬≤', '4 m/s¬≤', '12 m/s¬≤', '6 m/s¬≤'], correct: '8 m/s¬≤', hint: 'Acelera√ß√£o = dV/dt. Derive e substitua t=2', level: 'professor' },
    
    // ========== INTEGRAIS ==========
    { question: '‚à´(3x¬≤ - 2x + 1) dx = ?', options: ['x¬≥ - x¬≤ + x + C', 'x¬≥ + x¬≤ + x + C', '6x - 2 + C', 'x¬≥ - x¬≤ + C'], correct: 'x¬≥ - x¬≤ + x + C', hint: 'Integre termo a termo: ‚à´x^n dx = x^{n+1}/(n+1)', level: 'dificil' },
    { question: '‚à´‚ÇÄ¬≤ (2x + 1) dx = ?', options: ['6', '4', '5', '3'], correct: '6', hint: 'Primitiva: x¬≤ + x. Calcule F(2) - F(0)', level: 'dificil' },
    { question: 'Se f\'(x) = 4x¬≥, qual √© f(x)?', options: ['x‚Å¥ + C', '12x¬≤ + C', 'x‚Å¥', '4x‚Å¥ + C'], correct: 'x‚Å¥ + C', hint: 'Integre a derivada para obter a fun√ß√£o original', level: 'medio' },
    { question: 'Qual a √°rea sob y = 2x de x=1 a x=3?', options: ['8', '6', '4', '10'], correct: '8', hint: 'Calcule ‚à´‚ÇÅ¬≥ 2x dx = [x¬≤]‚ÇÅ¬≥ = 9 - 1', level: 'dificil' },
    
    // ========== APLICA√á√ïES ==========
    { question: 'Um cubo expande com aresta a = 2t cm. Qual dV/dt quando t=1s?', options: ['24 cm¬≥/s', '12 cm¬≥/s', '8 cm¬≥/s', '6 cm¬≥/s'], correct: '24 cm¬≥/s', hint: 'V = a¬≥ = 8t¬≥. dV/dt = 24t¬≤. Substitua t=1', level: 'professor' },
    { question: 'Se a posi√ß√£o s(t) = 2t¬≥ - 3t (m), qual a velocidade em t=1s?', options: ['3 m/s', '1 m/s', '0 m/s', '6 m/s'], correct: '3 m/s', hint: 'v(t) = ds/dt = 6t¬≤ - 3. Avalie em t=1', level: 'dificil' },
    { question: 'Um bal√£o esf√©rico infla a dV/dt = 10œÄ cm¬≥/s. Qual dr/dt quando r=5 cm?', options: ['0.1 cm/s', '0.2 cm/s', '0.4 cm/s', '0.5 cm/s'], correct: '0.1 cm/s', hint: 'V = 4/3œÄr¬≥ ‚Üí dV/dr = 4œÄr¬≤. Use dr/dt = (dV/dt)/(dV/dr)', level: 'professor' }
];

        // Mapeia a dificuldade √† quantidade de quest√µes e ao tempo adicional da dica
        const DIFFICULTY_SETTINGS = {
            'facil': { numQuestions: 5, hintTimeBonus: 5, levels: ['facil'] },
            'medio': { numQuestions: 10, hintTimeBonus: 7, levels: ['facil', 'medio'] }, 
            'dificil': { numQuestions: 20, hintTimeBonus: 10, levels: ['facil', 'medio', 'dificil'] },
            'professor': { numQuestions: 5, hintTimeBonus: 15, levels: ['professor'] } 
        };
        const BASE_TIME_PER_QUESTION = 30; // Segundos iniciais
        const MAX_RANKING_ENTRIES = 10; // Limite de entradas no ranking

        // --- VARI√ÅVEIS DE ESTADO DO JOGO ---
        let currentQuestionIndex = 0;
        let timerInterval;
        let shuffledQuestions = [];
        let score = 0;
        let proceedingToNextQuestion = false; // Flag para controlar a transi√ß√£o
        let playerName = 'Jogador'; // Nome padr√£o
        let gameStartTime; // Para calcular o tempo total do jogo
        let currentDifficulty = 'facil'; // Dificuldade atual do jogo
        let hintUsedForCurrentQuestion = false; // Flag para saber se a dica foi usada na quest√£o atual
        let timeLeftOnTimer = BASE_TIME_PER_QUESTION; // Vari√°vel para controlar o tempo restante do timer
        let lastPlayerName = ''; // Para armazenar o nome do √∫ltimo jogador
        let isAdminMode = false; // NOVA VARI√ÅVEL: Controla o modo admin
        let adminKeySequence = []; // Para a sequ√™ncia da senha do admin

        // --- ELEMENTOS DO DOM E MODAIS BOOTSTRAP ---
        const startScreen = document.getElementById('startScreen');
        const nameModalEl = document.getElementById('nameModal');
        const confirmPlayerModalEl = document.getElementById('confirmPlayerModal'); // Novo modal de confirma√ß√£o
        const difficultyModalEl = document.getElementById('difficultyModal');
        const questionModalEl = document.getElementById('questionModal');
        const hintModalEl = document.getElementById('hintModal');
        const resultModalEl = document.getElementById('resultModal');
        const rankingModalEl = document.getElementById('rankingModal');
        const adminModeAlert = document.getElementById('adminModeAlert'); // Elemento do alerta admin

        const nameModal = new bootstrap.Modal(nameModalEl);
        const confirmPlayerModal = new bootstrap.Modal(confirmPlayerModalEl); // Novo modal de confirma√ß√£o
        const difficultyModal = new bootstrap.Modal(difficultyModalEl);
        const questionModal = new bootstrap.Modal(questionModalEl);
        const hintModal = new bootstrap.Modal(hintModalEl);
        const resultModal = new bootstrap.Modal(resultModalEl);
        const rankingModal = new bootstrap.Modal(rankingModalEl);

        const playerNameInput = document.getElementById('playerNameInput');
        const continueToDifficultyBtn = document.getElementById('continueToDifficultyBtn');
        const lastPlayerNameText = document.getElementById('lastPlayerNameText'); // Elemento para mostrar o √∫ltimo nome
        const changePlayerNameBtn = document.getElementById('changePlayerNameBtn'); // Bot√£o para mudar nome
        const continueWithLastPlayerBtn = document.getElementById('continueWithLastPlayerBtn'); // Bot√£o para continuar com √∫ltimo nome
        const difficultyButtons = document.querySelectorAll('#difficultyModal .btn-lg'); // Bot√µes de dificuldade
        const questionCountEl = document.getElementById('questionCount');
        const questionTextEl = document.getElementById('questionText');
        const answersContainerEl = document.getElementById('answersContainer');
        const timerBarEl = document.getElementById('timerBar');
        const hintButton = document.getElementById('hintButton');
        const hintTextEl = document.getElementById('hintText');
        
        const resultIconEl = document.getElementById('resultIcon');
        const resultTitleEl = document.getElementById('resultTitle');
        const resultMessageEl = document.getElementById('resultMessage');
        const rankingTableBody = document.getElementById('rankingTableBody');
        
        // --- LISTENERS DE EVENTOS ---

        // Evento que dispara AP√ìS o modal da pergunta ser completamente escondido
        questionModalEl.addEventListener('hidden.bs.modal', () => {
            if (proceedingToNextQuestion) {
                proceedingToNextQuestion = false; // Reseta a flag
                showQuestion();
            }
        });

        // Evento AP√ìS o modal do ranking ser completamente escondido
        rankingModalEl.addEventListener('hidden.bs.modal', () => {
            startScreen.classList.remove('d-none'); // Reexibe a tela inicial
        });

        // Evento para continuar do modal de nome para o modal de dificuldade
        continueToDifficultyBtn.addEventListener('click', () => {
            const inputName = playerNameInput.value.trim();
            if (inputName) {
                playerName = inputName;
                localStorage.setItem('lastPlayerName', playerName); // Salva o nome como √∫ltimo jogador
                nameModal.hide();
                difficultyModal.show(); // Mostra o modal de dificuldade
            } else {
                alert('Por favor, digite seu nome para continuar!');
                playerNameInput.focus();
            }
        });

        // Eventos para o modal de confirma√ß√£o do √∫ltimo jogador
        changePlayerNameBtn.addEventListener('click', () => {
            confirmPlayerModal.hide();
            playerNameInput.value = ''; // Limpa o campo para novo nome
            nameModal.show(); // Volta para o modal de nome para o usu√°rio digitar um novo nome
            playerNameInput.focus();
        });

        continueWithLastPlayerBtn.addEventListener('click', () => {
            playerName = lastPlayerName; // Usa o nome do √∫ltimo jogador
            confirmPlayerModal.hide();
            difficultyModal.show(); // Vai direto para o modal de dificuldade
        });


        // Eventos para os bot√µes de dificuldade
        difficultyButtons.forEach(button => {
            button.addEventListener('click', (event) => {
                currentDifficulty = event.target.dataset.difficulty;
                difficultyModal.hide();
                startGame(); // Inicia o jogo ap√≥s a sele√ß√£o de dificuldade
            });
        });

        // Evento do bot√£o de dica
        hintButton.addEventListener('click', () => {
            if (hintUsedForCurrentQuestion) return; // N√£o permite usar a dica mais de uma vez
            
            const currentQuestion = shuffledQuestions[currentQuestionIndex];
            if (currentQuestion && currentQuestion.hint) {
                hintTextEl.textContent = currentQuestion.hint;
                hintModal.show();
                hintUsedForCurrentQuestion = true; // Marca a dica como usada
                hintButton.disabled = true; // Desabilita o bot√£o de dica

                // Aumenta o tempo restante da quest√£o
                clearInterval(timerInterval); // Para o timer atual
                const timeBonus = DIFFICULTY_SETTINGS[currentDifficulty].hintTimeBonus;
                timeLeftOnTimer += timeBonus;
                // Limita o tempo m√°ximo para n√£o se tornar excessivo
                const maxTime = BASE_TIME_PER_QUESTION + timeBonus;
                if (timeLeftOnTimer > maxTime) {
                    timeLeftOnTimer = maxTime;
                }
                startTimer(timeLeftOnTimer); // Reinicia o timer com o tempo extra
            } else {
                alert('N√£o h√° dica dispon√≠vel para esta quest√£o.');
            }
        });

        // LISTENER PARA O MODO ADMIN
        document.addEventListener('keydown', (event) => {
            adminKeySequence.push(event.key.toLowerCase());
            // Mant√©m a sequ√™ncia com os √∫ltimos 5 caracteres para "admin"
            if (adminKeySequence.length > 5) {
                adminKeySequence.shift(); 
            }

            if (adminKeySequence.join('') === 'admin') {
                isAdminMode = !isAdminMode; // Alterna o modo admin
                adminKeySequence = []; // Reseta a sequ√™ncia
                
                adminModeAlert.textContent = isAdminMode ? 'Modo Admin Ativado!' : 'Modo Admin Desativado!';
                adminModeAlert.classList.add('show');
                setTimeout(() => {
                    adminModeAlert.classList.remove('show');
                }, 2000); 
            }
        });


        // --- L√ìGICA DO JOGO ---

        function showNameModal() {
            startScreen.classList.add('d-none');
            lastPlayerName = localStorage.getItem('lastPlayerName');

            if (lastPlayerName) {
                lastPlayerNameText.textContent = lastPlayerName;
                confirmPlayerModal.show(); // Mostra modal de confirma√ß√£o
            } else {
                playerNameInput.value = ''; // Limpa o campo do nome
                nameModal.show(); // Mostra modal de nome
                playerNameInput.focus();
            }
        }

        function startGame() {
            const numQuestionsForLevel = DIFFICULTY_SETTINGS[currentDifficulty].numQuestions;
            const allowedLevels = DIFFICULTY_SETTINGS[currentDifficulty].levels;
            
            let availableQuestions = allQuestions.filter(q => allowedLevels.includes(q.level));

            availableQuestions.sort(() => Math.random() - 0.5);

            shuffledQuestions = availableQuestions.slice(0, numQuestionsForLevel);

            if (shuffledQuestions.length < numQuestionsForLevel) {
                console.warn(`Aten√ß√£o: N√£o h√° quest√µes suficientes para a dificuldade "${currentDifficulty}". Apenas ${shuffledQuestions.length} quest√µes dispon√≠veis.`);
            }

            currentQuestionIndex = 0;
            score = 0;
            gameStartTime = Date.now(); // Inicia o cron√¥metro do jogo
            hintUsedForCurrentQuestion = false; // Reseta para a nova partida

            showQuestion();
        }

        function showQuestion() {
            // Se n√£o houver quest√µes embaralhadas, ou se j√° passamos por todas
            if (!shuffledQuestions || currentQuestionIndex >= shuffledQuestions.length) {
                // Fim do jogo - Vit√≥ria
                const gameEndTime = Date.now();
                const totalTimeSeconds = ((gameEndTime - gameStartTime) / 1000).toFixed(2);
                showResult(true, score, shuffledQuestions.length, totalTimeSeconds); 
                return;
            }

            const q = shuffledQuestions[currentQuestionIndex];
            questionCountEl.textContent = `${currentQuestionIndex + 1} / ${shuffledQuestions.length}`;
            questionTextEl.textContent = q.question;
            answersContainerEl.innerHTML = '';
            hintButton.disabled = false; // Habilita o bot√£o de dica para a nova quest√£o
            hintUsedForCurrentQuestion = false; // Reseta a flag da dica para a nova quest√£o

            // Embaralha as op√ß√µes de resposta
            const shuffledOptions = [...q.options].sort(() => Math.random() - 0.5);
            shuffledOptions.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add('btn', 'btn-outline-light', 'answer-btn');
                button.onclick = () => checkAnswer(option, q.correct, button);
                answersContainerEl.appendChild(button);

                // NOVO: Destaca a resposta correta em modo admin
                if (isAdminMode && option === q.correct) {
                    button.classList.add('btn-success'); // Marca o bot√£o correto em verde
                    button.classList.remove('btn-outline-light'); // Remove o estilo de outline
                }
            });
            
            questionModal.show();
            startTimer(BASE_TIME_PER_QUESTION); // Inicia o timer com o tempo base
        }

        function checkAnswer(selectedAnswer, correctAnswer, button) {
            clearInterval(timerInterval);
            
            // Desabilita todos os bot√µes para evitar cliques m√∫ltiplos
            const answerButtons = answersContainerEl.querySelectorAll('.btn');
            answerButtons.forEach(btn => btn.disabled = true);
            hintButton.disabled = true; // Desabilita a dica ao responder

            if (selectedAnswer === correctAnswer) {
                if (!isAdminMode) {
                    button.classList.remove('btn-outline-light');
                    button.classList.add('btn-success');
                }
                score++;
                currentQuestionIndex++;
                proceedingToNextQuestion = true; 
                
                setTimeout(() => {
                    questionModal.hide(); 
                }, 1000);

            } else {
                if (!isAdminMode) {
                    button.classList.remove('btn-outline-light');
                    button.classList.add('btn-danger');
                    
                    answerButtons.forEach(btn => {
                        if (btn.textContent === correctAnswer) {
                            btn.classList.remove('btn-outline-light');
                            btn.classList.add('btn-success');
                        }
                    });
                }

                setTimeout(() => {
                    questionModal.hide();
                    const gameEndTime = Date.now();
                    const totalTimeSeconds = ((gameEndTime - gameStartTime) / 1000).toFixed(2);
                    showResult(false, score, shuffledQuestions.length, totalTimeSeconds, 'Resposta errada!'); 
                }, 1500);
            }
        }

        function startTimer(duration) {
            timeLeftOnTimer = duration; // Define o tempo inicial do timer
            timerBarEl.style.width = '100%';
            timerBarEl.className = 'progress-bar bg-primary'; // Reseta as cores
            
            timerInterval = setInterval(() => {
                timeLeftOnTimer--;
                const percentage = (timeLeftOnTimer / duration) * 100;
                timerBarEl.style.width = `${percentage}%`;

                if (percentage < 50 && percentage > 20) {
                    timerBarEl.classList.remove('bg-primary');
                    timerBarEl.classList.add('bg-warning');
                } else if(percentage <= 20) {
                    timerBarEl.classList.remove('bg-warning');
                    timerBarEl.classList.add('bg-danger');
                }

                if (timeLeftOnTimer <= 0) {
                    clearInterval(timerInterval);
                    questionModal.hide();
                    const gameEndTime = Date.now();
                    const totalTimeSeconds = ((gameEndTime - gameStartTime) / 1000).toFixed(2);
                    showResult(false, score, shuffledQuestions.length, totalTimeSeconds, 'O tempo acabou!'); 
                }
            }, 1000);
        }
        
        function showResult(isSuccess, finalScore, totalQuestionsAttempted, totalTime, message = '') {
            clearInterval(timerInterval); // Garante que o timer seja parado
            
            if (isSuccess) {
                resultIconEl.textContent = 'üéâ';
                resultTitleEl.textContent = 'Bomba Desarmada!';
                resultMessageEl.textContent = `Parab√©ns, ${playerName}! Voc√™ acertou ${finalScore} de ${totalQuestionsAttempted} quest√µes em ${totalTime} segundos no n√≠vel ${currentDifficulty.charAt(0).toUpperCase() + currentDifficulty.slice(1)}!`;
                resultTitleEl.classList.remove('text-danger');
                resultTitleEl.classList.add('text-success');
                launchConfetti();
            } else {
                document.body.classList.add('explode-animation');
                resultIconEl.textContent = 'üí•';
                resultTitleEl.textContent = 'BOOM!';
                resultMessageEl.textContent = `${message} Voc√™ acertou ${finalScore} de ${totalQuestionsAttempted} quest√µes no n√≠vel ${currentDifficulty.charAt(0).toUpperCase() + currentDifficulty.slice(1)}.`;
                resultTitleEl.classList.remove('text-success');
                resultTitleEl.classList.add('text-danger');
            }

            if (gameStartTime) { 
                saveRankingEntry(playerName, finalScore, totalQuestionsAttempted, totalTime, currentDifficulty);
            }

            resultModal.show();
        }
        
        function restartGame() {
            resultModal.hide();
            document.body.classList.remove('explode-animation');
            showNameModal(); 
        }

        function getRanking() {
            const ranking = localStorage.getItem('bombRanking');
            return ranking ? JSON.parse(ranking) : [];
        }

        function saveRankingEntry(name, score, totalQuestions, time, difficulty) {
            let ranking = getRanking();
            const newEntry = {
                name: name,
                score: score,
                totalQuestions: totalQuestions,
                time: parseFloat(time), 
                difficulty: difficulty,
                date: new Date().toISOString()
            };

            const existingEntryIndex = ranking.findIndex(
                entry => entry.name === name && entry.difficulty === difficulty
            );

            if (existingEntryIndex > -1) {
           
                const existingEntry = ranking[existingEntryIndex];
              
                if (newEntry.score > existingEntry.score || 
                    (newEntry.score === existingEntry.score && newEntry.time < existingEntry.time)) {
                    ranking[existingEntryIndex] = newEntry; 
                    console.log(`Ranking atualizado para ${name} no n√≠vel ${difficulty}: Melhor tempo/score!`);
                } else {
                    console.log(`Resultado de ${name} no n√≠vel ${difficulty} n√£o √© melhor que o existente. N√£o atualizado.`);
                }
            } else {
                ranking.push(newEntry);
                console.log(`Nova entrada no ranking para ${name} no n√≠vel ${difficulty}.`);
            }

            sortRanking(ranking);

            if (ranking.length > MAX_RANKING_ENTRIES) {
                ranking = ranking.slice(0, MAX_RANKING_ENTRIES);
            }

            localStorage.setItem('bombRanking', JSON.stringify(ranking));
        }

        // Fun√ß√£o auxiliar para ordenar o ranking
        function sortRanking(rankingArray) {
            // A ordem de prioridade das dificuldades para ordena√ß√£o do ranking
            const difficultyOrder = ['professor', 'dificil', 'medio', 'facil'];

            rankingArray.sort((a, b) => {
                // 1. Por Dificuldade (professor > dificil > medio > facil)
                const diffA = difficultyOrder.indexOf(a.difficulty);
                const diffB = difficultyOrder.indexOf(b.difficulty);
                if (diffA !== diffB) {
                    return diffA - diffB;
                }

                // 2. Por Score (maior primeiro)
                if (b.score !== a.score) {
                    return b.score - a.score;
                }

                // 3. Por Tempo (menor primeiro)
                return a.time - b.time;
            });
        }


        // Fun√ß√£o para exibir o modal do ranking
        function showRanking() {
            let ranking = getRanking();
            rankingTableBody.innerHTML = ''; // Limpa a tabela

            if (ranking.length === 0) {
                rankingTableBody.innerHTML = '<tr><td colspan="6" class="text-center">Nenhum recorde ainda. Seja o primeiro a desarmar uma bomba!</td></tr>';
            } else {
                // Garante que o ranking est√° ordenado antes de exibir
                sortRanking(ranking); 
                
                // Exibe as entradas at√© o limite definido em MAX_RANKING_ENTRIES
                const entriesToDisplay = ranking.slice(0, MAX_RANKING_ENTRIES);
                entriesToDisplay.forEach((entry, index) => {
                    const row = rankingTableBody.insertRow();
                    // A classe 'completed-game' aqui √© apenas visual, para destacar
                    // Se voc√™ quiser diferenciar jogos ganhos de perdidos no ranking,
                    // voc√™ precisaria salvar um status de 'isSuccess' na entrada do ranking.
                    row.classList.add('completed-game'); 
                    row.innerHTML = `
                        <th scope="row">${index + 1}</th>
                        <td>${entry.name}</td>
                        <td>${entry.score}</td>
                        <td>${entry.totalQuestions}</td>
                        <td>${entry.time.toFixed(2)}s</td>
                        <td>${entry.difficulty.charAt(0).toUpperCase() + entry.difficulty.slice(1)}</td>
                    `;
                });
            }
            // Garante que a tela inicial esteja escondida e mostra o modal do ranking
            startScreen.classList.add('d-none'); // Esconde a tela inicial
            nameModal.hide();
            confirmPlayerModal.hide();
            difficultyModal.hide();
            questionModal.hide();
            hintModal.hide();
            resultModal.hide();
            
            rankingModal.show();
        }

        function showRankingFromResults() {
            resultModal.hide(); // Esconde o modal de resultados
            showRanking(); // Chama a fun√ß√£o que popula e mostra o ranking
        }

        // Fun√ß√£o para apagar todos os dados do localStorage
        function clearAllData() {
            if (confirm('Tem certeza que deseja apagar todos os dados do ranking e o √∫ltimo nome salvo? Esta a√ß√£o √© irrevers√≠vel.')) {
                localStorage.removeItem('bombRanking');
                localStorage.removeItem('lastPlayerName');
                alert('Todos os dados foram apagados com sucesso!');
                // Opcional: recarregar a p√°gina para garantir que tudo esteja limpo
                location.reload(); 
            }
        }

        // --- EFEITOS VISUAIS ---
        function launchConfetti() {
            const duration = 2 * 1000;
            const animationEnd = Date.now() + duration;
            const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 1056 }; // zIndex maior que o do modal

            function randomInRange(min, max) {
                return Math.random() * (max - min) + min;
            }

            const interval = setInterval(function() {
                const timeLeft = animationEnd - Date.now();

                if (timeLeft <= 0) {
                    return clearInterval(interval);
                }

                const particleCount = 50 * (timeLeft / duration);
                // Lan√ßa confetes de ambos os lados da tela
                confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } });
                confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } });

            }, 250);
        }

    </script>
</body>
</html>